<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ePub Pro: Reader & Translator</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

    <style>
        /* --- CSS UTAMA --- */
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f4; overflow: hidden; }
        
        /* Toolbar */
        .toolbar { padding: 0 15px; background: #fff; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 100; position: relative;}
        
        /* PROGRESS BAR */
        #progressBarContainer {
            position: fixed; top: 60px; left: 0; width: 100%; height: 4px;
            background: #eee; z-index: 99;
        }
        #progressBarFill {
            height: 100%; width: 0%; background: #007bff;
            transition: width 0.3s ease;
        }

        .btn-group { display: flex; align-items: center; gap: 8px; }
        .btn-group button, .btn-group select { padding: 8px 12px; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px; transition: 0.2s; font-size: 14px;}
        .btn-group button:hover { background: #eee; }
        .btn-primary { background-color: #007bff !important; color: white; border: none !important; }
        
        /* Tombol Khusus */
        .btn-translate { border: 1px solid #28a745 !important; color: white; background: #28a745 !important; font-weight: bold;}
        .btn-highlight { border: 1px solid #ffc107 !important; background: #fff3cd !important; color: #856404; font-weight: bold;}
        .btn-clear-highlight { border: 1px solid #dc3545 !important; color: #dc3545; background: #fff !important; }
        .btn-clear-highlight:hover { background: #dc3545 !important; color: white !important; }

        .info-badge { background: #f8f9fa; padding: 6px 12px; border-radius: 20px; font-family: monospace; font-size: 13px; font-weight: bold; color: #555; border: 1px solid #ddd; display: flex; align-items: center; gap: 5px; white-space: nowrap;}

        #viewer { flex: 1; width: 100%; background-color: white; margin: 0 auto; position: relative; overflow: hidden; }

        /* Sidebar & Modal Styles */
        #tocSidebar { position: absolute; top: 60px; left: 0; bottom: 0; width: 280px; background: white; border-right: 1px solid #ccc; transform: translateX(-100%); transition: transform 0.3s ease; z-index: 190; display: flex; flex-direction: column; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        #tocSidebar.open { transform: translateX(0); }
        .toc-header { padding: 15px; border-bottom: 1px solid #eee; background: #f9f9f9; font-weight: bold; display: flex; justify-content: space-between; align-items: center;}
        .toc-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .toc-item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; color: #333; transition: 0.2s; }
        .toc-item:hover { background: #f0f8ff; color: #007bff; padding-left: 20px; }

        #searchSidebar { position: absolute; top: 60px; right: 0; bottom: 0; width: 320px; background: white; border-left: 1px solid #ccc; transform: translateX(100%); transition: transform 0.3s ease; z-index: 200; display: flex; flex-direction: column; }
        #searchSidebar.open { transform: translateX(0); }
        .search-header { padding: 15px; border-bottom: 1px solid #eee; background: #f9f9f9; }
        .search-input-group { display: flex; gap: 5px; margin-top: 5px;}
        .search-input-group input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .search-results { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; }
        .search-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .search-item:hover { background: #f0f8ff; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); position: relative; display: flex; flex-direction: column; gap: 10px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #888; padding: 0; }
        .translate-box { background: #f0fdf4; padding: 15px; border-radius: 8px; border: 1px solid #dcfce7; color: #166534; font-size: 1.1em; line-height: 1.5; min-height: 50px;}
        .source-text { font-style: italic; color: #666; font-size: 0.95em; margin-bottom: 5px; border-left: 3px solid #ccc; padding-left: 10px; }

        .nav-btn { position: fixed; top: 50%; transform: translateY(-50%); padding: 20px; background: rgba(0,0,0,0.05); border: none; cursor: pointer; font-size: 30px; z-index: 90; color: #aaa; transition: 0.3s; border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; }
        .nav-btn:hover { background: rgba(0,0,0,0.2); color: #333; }
        #prev { left: 20px; } #next { right: 20px; }

        /* Dark Mode */
        body.dark-mode { background-color: #222; color: #ddd; }
        body.dark-mode .toolbar, body.dark-mode #searchSidebar, body.dark-mode #tocSidebar { background-color: #333; border-color: #444; color: #fff; }
        body.dark-mode .modal-content { background-color: #333; color: #fff; }
        body.dark-mode .translate-box { background-color: #14532d; border-color: #166534; color: #dcfce7; }
        body.dark-mode .source-text { color: #aaa; border-left-color: #555; }
        body.dark-mode select, body.dark-mode input { background: #444; color: white; border-color: #555; }
        body.dark-mode .info-badge { background: #444; border-color: #555; color: #ccc; }
        body.dark-mode .toc-item:hover, body.dark-mode .search-item:hover { background-color: #444; color: #fff; }
        body.dark-mode .toc-header, body.dark-mode .search-header { background-color: #444; border-color: #555; }
        
        body.dark-mode .btn-highlight { background-color: #554400 !important; color: #ffeb3b; border-color: #665500 !important; }
        body.dark-mode .btn-clear-highlight { border-color: #e74c3c !important; color: #e74c3c; background: transparent !important; }
        body.dark-mode #progressBarContainer { background: #333; }
        body.dark-mode #progressBarFill { background: #00bcd4; }

        ::selection { background: #cce5ff; }
    </style>
</head>
<body>

    <div class="toolbar">
        <div style="display: flex; align-items: center; gap: 10px;">
            <button onclick="goBack()" style="padding: 8px;">&larr;</button>
            <button onclick="toggleTOC()" title="Daftar Isi">‚ò∞ Menu</button>
            <div style="display: flex; flex-direction: column;">
                <strong id="titleDisplay" style="font-size: 14px; overflow: hidden; white-space: nowrap; max-width: 150px;">Memuat...</strong>
            </div>
        </div>
        
        <div class="btn-group">
            <div class="info-badge" title="Halaman">üìÑ <span id="pageCountDisplay">--</span></div>
            <div class="info-badge" title="Waktu">‚è±Ô∏è <span id="readingTime">00:00</span></div>
            
            <button onclick="toggleSearch()" title="Cari Kata">üîç</button>
            <button onclick="saveCurrentPosition()" class="btn-primary" title="Simpan Bookmark">üîñ</button>

            <button onclick="highlightSelection()" class="btn-highlight" title="Stabilo Teks Terpilih">üñçÔ∏è</button>
            <button onclick="clearAllHighlights()" class="btn-clear-highlight" title="Hapus Semua Stabilo">üóëÔ∏è</button>

            <select id="targetLang">
                <option value="id" selected>üáÆüá© Indo</option>
                <option value="en">üá¨üáß Eng</option>
                <option value="jv">Jawa</option>
                <option value="su">Sunda</option>
            </select>
            
            <button onclick="translateSelection()" class="btn-translate" title="Translate Teks Terpilih">üî§ Translate</button>
            <button onclick="toggleTheme()" id="themeBtn">üåô</button>
        </div>
    </div>

    <div id="progressBarContainer">
        <div id="progressBarFill"></div>
    </div>

    <div id="viewer"></div>

    <div id="tocSidebar">
        <div class="toc-header">
            <span>üìñ Daftar Isi</span>
            <button onclick="toggleTOC()" style="border:none; background:none; cursor:pointer; font-size:16px;">&times;</button>
        </div>
        <ul id="tocList" class="toc-list"><li style="padding:15px; color:#888;">Memuat Bab...</li></ul>
    </div>

    <div id="searchSidebar">
        <div class="search-header">
            <h4>Pencarian Kata</h4>
            <div class="search-input-group">
                <input type="text" id="searchInput" placeholder="Cari kata...">
                <button onclick="performSearch()">Go</button>
            </div>
            <small id="searchStatus" style="display:block; margin-top:5px; color: #888;"></small>
        </div>
        <ul class="search-results" id="searchResultsList"></ul>
    </div>

    <div id="translateModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; color:#28a745;">Terjemahan</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <small>Asli:</small>
            <div id="sourceTextDisplay" class="source-text">...</div>
            <small>Hasil:</small>
            <div id="translatedResult" class="translate-box">Loading...</div>
            <div style="text-align: right; font-size: 0.8em; color: #888; margin-top:5px;">Powered by MyMemory</div>
        </div>
    </div>

    <button id="prev" class="nav-btn">‚ùÆ</button>
    <button id="next" class="nav-btn">‚ùØ</button>

    <script>
        // 1. SETUP & LOAD BUKU
        let bookPath = localStorage.getItem('currentBook');
        let bookTitle = localStorage.getItem('currentBookTitle'); 
        let resumeCFI = localStorage.getItem('resumeCFI');
        const currentUser = localStorage.getItem('user') || 'guest';

        // --- CEK TEMA SAAT LOAD (Agar sinkron dengan Dashboard) ---
        let isDarkMode = localStorage.getItem('theme') === 'dark';
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
        }

        if (!bookPath) { alert("Pilih buku dulu!"); window.location.href = 'dashboard.html'; }
        bookPath = bookPath.replace(/\\/g, "/"); 

        var book = ePub(bookPath);
        var rendition = book.renderTo("viewer", { width: "100%", height: "100%", flow: "paginated", allowScriptedContent: true });
        
        var displayPromise = resumeCFI ? rendition.display(resumeCFI) : rendition.display();
        
        displayPromise.catch(err => { console.error(err); alert("Gagal load buku."); });

        var currentSelectedText = ""; 
        var currentCfiRange = null; 
        
        // Simpan data highlight di variabel lokal (array)
        let currentHighlights = []; 

        // Theme Configuration
        rendition.themes.register("dark", { body: { color: "#cfcfcf", background: "#222" }, "mark": { fill: "orange" } });
        rendition.themes.register("light", { body: { color: "#000", background: "#fff" }, "mark": { fill: "yellow" } });

        // Terapkan tema ke buku setelah render
        rendition.on("rendered", function() {
            if (isDarkMode) {
                rendition.themes.select("dark");
                document.getElementById('themeBtn').innerText = "‚òÄÔ∏è";
            } else {
                rendition.themes.select("light");
                document.getElementById('themeBtn').innerText = "üåô";
            }
            // Load Highlight juga disini
            loadSavedHighlights();
        });

        // Metadata & Page Count
        book.ready.then(() => { return book.loaded.metadata; }).then((meta) => {
            if(!bookTitle) bookTitle = meta.title;
            document.getElementById('titleDisplay').innerText = bookTitle;
            return book.locations.generate(1000); 
        }).then(() => { updatePageInfo(); });

        // Load TOC
        book.loaded.navigation.then(toc => {
            const list = document.getElementById('tocList');
            list.innerHTML = '';
            toc.forEach(chapter => {
                let li = document.createElement('li');
                li.className = 'toc-item';
                li.innerText = chapter.label.trim();
                li.onclick = () => { rendition.display(chapter.href); toggleTOC(); };
                list.appendChild(li);
            });
        });

        // ==========================================
        //  LOGIKA STABILO SERVER-SIDE (JSON)
        // ==========================================

        function loadSavedHighlights() {
            const url = `/api/highlights?user=${encodeURIComponent(currentUser)}&bookPath=${encodeURIComponent(bookPath)}`;
            
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    currentHighlights = data; 
                    currentHighlights.forEach(cfi => {
                        rendition.annotations.add("highlight", cfi);
                    });
                })
                .catch(err => console.error("Gagal load highlight:", err));
        }

        // 2. SAVE: Fungsi sinkronisasi ke server
        function syncHighlightsToServer() {
            fetch('/api/highlights', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user: currentUser,
                    bookPath: bookPath,
                    highlights: currentHighlights
                })
            }).then(res => console.log("Highlight tersimpan."));
        }

        // --- UPDATE HALAMAN & PROGRESS BAR ---
        rendition.on('relocated', location => { updatePageInfo(location); });

        function updatePageInfo(location) {
            const pageDisplay = document.getElementById('pageCountDisplay');
            const progressBar = document.getElementById('progressBarFill');

            if (!book.locations.length()) { pageDisplay.innerText = "Hitung..."; return; }
            
            const currentLocation = location || rendition.currentLocation();
            if (currentLocation && currentLocation.start) {
                const currentPage = book.locations.locationFromCfi(currentLocation.start.cfi);
                const totalPages = book.locations.total;
                
                pageDisplay.innerText = `${currentPage} / ${totalPages}`;
                
                const percentage = (currentPage / totalPages) * 100;
                progressBar.style.width = `${percentage}%`;
            }
        }

        // --- SELEKSI TEKS ---
        rendition.on("selected", function(cfiRange, contents) {
            currentCfiRange = cfiRange;
            book.getRange(cfiRange).then(function (range) { currentSelectedText = range.toString(); });
        });
        rendition.on("mousedown", function() { currentSelectedText = ""; currentCfiRange = null; });

        // --- TOMBOL STABILO (ADD) ---
        function highlightSelection() {
            if (!currentCfiRange) return alert("Blok teks dulu untuk distabilo!");
            
            rendition.annotations.add("highlight", currentCfiRange);
            
            // Tambahkan ke array lokal
            if (!currentHighlights.includes(currentCfiRange)) {
                currentHighlights.push(currentCfiRange);
                syncHighlightsToServer();
            }
            
            rendition.getRange(currentCfiRange).then(function (range) { window.getSelection().removeAllRanges(); });
            currentCfiRange = null; 
        }

        // --- HAPUS SATU (KLIK WARNA) ---
        rendition.on("markClicked", function(cfiRange, data) {
            if (confirm("Hapus stabilo ini?")) {
                rendition.annotations.remove(cfiRange, "highlight");
                
                currentHighlights = currentHighlights.filter(cfi => cfi !== cfiRange);
                syncHighlightsToServer();
            }
        });

        // --- HAPUS SEMUA ---
        function clearAllHighlights() {
            if (!confirm("Yakin hapus SEMUA stabilo di buku ini?")) return;

            // Hapus visual
            currentHighlights.forEach(cfi => rendition.annotations.remove(cfi, "highlight"));
            
            // Kosongkan data
            currentHighlights = [];
            syncHighlightsToServer();
            
            alert("Bersih!");
        }

        // --- TRANSLATE ---
        async function translateSelection() {
            if (!currentSelectedText || currentSelectedText.trim() === "") return alert("Blok teks dulu!");
            
            const targetLang = document.getElementById('targetLang').value;
            const modal = document.getElementById('translateModal');
            const resultBox = document.getElementById('translatedResult');
            const sourceBox = document.getElementById('sourceTextDisplay');

            modal.style.display = 'flex';
            sourceBox.innerText = `"${currentSelectedText}"`;
            resultBox.innerHTML = '‚è≥ Menerjemahkan...';

            try {
                let textToTranslate = currentSelectedText.length > 500 ? currentSelectedText.substring(0, 500) : currentSelectedText;
                const apiUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(textToTranslate)}&langpair=en|${targetLang}`;
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data && data.responseData) resultBox.innerText = data.responseData.translatedText;
                else resultBox.innerText = "Gagal API.";
            } catch (err) { resultBox.innerHTML = `Gagal koneksi.`; }
        }

        function closeModal() { document.getElementById('translateModal').style.display = 'none'; }
        window.onclick = function(e) { if(e.target == document.getElementById('translateModal')) closeModal(); }

        // --- UTILITY ---
        function saveCurrentPosition() {
            const loc = rendition.currentLocation();
            if (loc && loc.start) {
                let bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || [];
                bookmarks = bookmarks.filter(b => b.filepath !== bookPath);
                
                let pageLabel = "";
                if (book.locations.length()) {
                    const currentPage = book.locations.locationFromCfi(loc.start.cfi);
                    const totalPages = book.locations.total;
                    pageLabel = `Hal ${currentPage} dari ${totalPages}`;
                }

                bookmarks.push({
                    title: bookTitle || "Buku", filepath: bookPath, cfi: loc.start.cfi, pageLabel: pageLabel, 
                    timestamp: new Date().toLocaleDateString('id-ID') + ' ' + new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})
                });
                localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
                alert(`Posisi tersimpan! (${pageLabel})`);
            }
        }

        function toggleTOC() { document.getElementById('tocSidebar').classList.toggle('open'); document.getElementById('searchSidebar').classList.remove('open'); }
        function toggleSearch() { document.getElementById('searchSidebar').classList.toggle('open'); document.getElementById('tocSidebar').classList.remove('open'); document.getElementById('searchInput').focus(); }

        async function performSearch() {
            const query = document.getElementById('searchInput').value;
            const list = document.getElementById('searchResultsList');
            const status = document.getElementById('searchStatus');
            if (query.length < 3) return alert("Minimal 3 huruf!");
            list.innerHTML = ''; status.innerText = "Mencari...";
            rendition.annotations.remove("highlight"); 

            try {
                var results = [];
                await Promise.all(book.spine.spineItems.map(item => {
                    return item.load(book.load.bind(book)).then(item.find.bind(item, query)).then(found => {
                        found.forEach(f => { f.label = item.label ? item.label.trim() : "Halaman"; results.push(f); });
                    });
                }));
                status.innerText = `Ditemukan ${results.length} hasil.`;
                results.forEach(result => {
                    const li = document.createElement('li');
                    li.className = 'search-item';
                    const snippet = result.excerpt.replace(new RegExp(query, "gi"), "<b>$&</b>");
                    li.innerHTML = `<strong>${result.label}</strong><p>...${snippet}...</p>`;
                    li.onclick = () => { 
                        rendition.display(result.cfi).then(() => { rendition.annotations.add("highlight", result.cfi); }); 
                    };
                    list.appendChild(li);
                });
            } catch (e) { status.innerText = "Error."; }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            
            // Simpan status tema ke localStorage agar dibaca oleh Dashboard
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                rendition.themes.select("dark");
                document.getElementById('themeBtn').innerText = "‚òÄÔ∏è";
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                rendition.themes.select("light");
                document.getElementById('themeBtn').innerText = "üåô";
                localStorage.setItem('theme', 'light');
            }
        }

        function goBack() { window.location.href = 'dashboard.html'; }

        document.getElementById("next").onclick = () => { rendition.next(); }; 
        document.getElementById("prev").onclick = () => { rendition.prev(); };
        document.addEventListener("keyup", (e) => { 
            if (e.key === "ArrowLeft") { rendition.prev(); }
            if (e.key === "ArrowRight") { rendition.next(); }
        });
        
        let totalSeconds = parseInt(localStorage.getItem('timer_' + bookPath)) || 0;
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                totalSeconds++;
                const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2,'0');
                const s = (totalSeconds % 60).toString().padStart(2,'0');
                document.getElementById('readingTime').innerText = `${m}:${s}`;
                localStorage.setItem('timer_' + bookPath, totalSeconds);
            }
        }, 1000);
    </script>
</body>
</html>