<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>ePub Library UIN</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; padding-bottom: 10px;}
        .card { border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 5px; display: flex; justify-content: space-between; }
        .upload-section { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        button { cursor: pointer; padding: 5px 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h2>Perpustakaan Digital FST</h2>
        <button onclick="logout()">Logout</button>
    </div>

    <div class="upload-section">
        <h3>Upload ePub Baru</h3>
        <input type="text" id="bookTitle" placeholder="Judul Buku" style="width: 100%; margin-bottom: 10px;">
        <select id="bookCategory" style="width: 100%; margin-bottom: 10px;">
            <option value="Informatika">Teknik Informatika</option>
            <option value="Sistem Informasi">Sistem Informasi</option>
            <option value="Biologi">Biologi</option>
            <option value="Matematika">Matematika</option>
        </select>
        <input type="file" id="fileInput" accept=".epub">
        <button onclick="uploadBook()" style="margin-top: 10px;">Upload</button>
    </div>

    <h3>Daftar Buku</h3>
    <select id="filterCategory" onchange="loadBooks()">
        <option value="All">Semua Prodi</option>
        <option value="Informatika">Teknik Informatika</option>
        <option value="Sistem Informasi">Sistem Informasi</option>
    </select>
    <div id="bookList"></div>

    <script>
        const currentUser = localStorage.getItem('user');
        if(!currentUser) window.location.href = 'index.html'; // Proteksi halaman

        async function uploadBook() {
            const title = document.getElementById('bookTitle').value;
            const category = document.getElementById('bookCategory').value;
            const fileInput = document.getElementById('fileInput');
            
            if(fileInput.files.length === 0) return alert("Pilih file dulu!");

            const formData = new FormData();
            formData.append('epubFile', fileInput.files[0]);
            formData.append('title', title);
            formData.append('category', category);
            formData.append('uploader', currentUser);

            const res = await fetch('/api/upload', { method: 'POST', body: formData });
            const data = await res.json();
            alert(data.message);
            loadBooks();
        }

        async function loadBooks() {
            const filter = document.getElementById('filterCategory').value;
            const res = await fetch('/api/books');
            const books = await res.json();
            
            const listDiv = document.getElementById('bookList');
            listDiv.innerHTML = '';

            books.forEach(book => {
                if(filter === 'All' || book.category === filter) {
                    listDiv.innerHTML += `
                        <div class="card">
                            <div>
                                <strong>${book.title}</strong> <br>
                                <small>Prodi: ${book.category} | Upload: ${book.uploader}</small>
                            </div>
                            <button onclick="bacaBuku('${book.filepath}')">BACA SEKARANG</button>
                        </div>
                    `;
                }
            });
        }

        function bacaBuku(path) {
            // Simpan path buku yg mau dibaca ke localStorage agar bisa diambil di halaman reader
            localStorage.setItem('currentBook', path);
            window.location.href = 'reader.html';
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        loadBooks(); // Load awal
    </script>
</body>
</html>